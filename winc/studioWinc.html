<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Rendimento WINC vs ACWE</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
    <!--<script src="js/ytm.js" defer></script>   -->

    <style>
        /* Stile per il grafico */
        #xyleChart {
            max-height: 500px;
            width: 100%;
        }

        .chart-container {
            position: relative;
            height: 500px;
            width: 100%;
        }
    </style>
    <style>
        .metric-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            min-height: 88px;
        }

        .metric-card strong {
            display: block;
            margin-bottom: 6px;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container mt-5 p-4 bg-white rounded shadow-sm">
        <div class="text-center mb-4">
            <a href="/FireSWR" class="home-button">üè† Home</a>
        </div>
        <br>
        <h1 class="text-center">Studio Rendimento WINC vs Decumulo equivalente da ACWE</h1>
        <h5 class="text-center">
            Studio comparativo di strategia covered call iShares World Equity High Income Active UCITS ETF USD Inc
            (WINC.DE) e il suo sottostante.
            Ho usato l'etf ACWE (SPDR All Country World UCITS Accumulating) come benchmark.
        </h5>
        <p class="text-center">Il grafico mostra come andrebbe una strategia che vende quote di ACWE per ottenere
            mensilmente lo stesso
            dividendo lordo staccato dall'ETF covered call.</p>
        <form>
            <div class="form-group mt-4">
                <label for="startDate">Data di inizio analisi:</label>
                <input type="date" class="form-control" id="startDate">
            </div>
            <div class="form-row mt-2">
                <div class="form-group col-md-6">
                    <label for="montante">Capitale inizale $:</label>
                    <input type="number" class="form-control" id="montante" value="100000" step="1000">
                </div>
                <div class="form-group col-md-6">
                    <label for="modalita">Modalit√† calcolo compravendita quote ETF:</label>
                    <select class="form-control" id="modalita">
                        <option value="0">Discreta (solo quote intere, come nella reat√†)</option>
                        <option value="1">Continua (anche quote frazionarie, per simulazione)</option>
                    </select>
                </div>
            </div>
            <div class="form-group mt-2">
                <label for="sellCommissionType">Tipo commissione vendita</label>
                <select class="form-control" id="sellCommissionType">
                    <option value="euro">Euro (‚Ç¨)</option>
                    <option value="percent">Percentuale (%)</option>
                </select>
            </div>
            <div class="form-row mt-2">
                <div class="form-group col-md-3">
                    <label for="sellCommission">Commissioni di vendita (‚Ç¨)</label>
                    <input type="number" class="form-control" id="sellCommission" value="7" step="0.01">
                </div>
                <div class="form-group col-md-3">
                    <label for="sellCommissionPercent">Commissioni di vendita (%)</label>
                    <input type="number" class="form-control" id="sellCommissionPercent" value="0.2" step="0.01">
                    <small class="form-text text-muted">Es. 0.2 = 0.2%</small>
                </div>
                <div class="form-group col-md-3">
                    <label for="sellCommissionMin">Commissione minima (‚Ç¨)</label>
                    <input type="number" class="form-control" id="sellCommissionMin" value="7" step="0.01">
                    <small class="form-text text-muted">0 = ignorata</small>
                </div>
                <div class="form-group col-md-3">
                    <label for="sellCommissionMax">Commissione massima (‚Ç¨)</label>
                    <input type="number" class="form-control" id="sellCommissionMax" value="19" step="0.01">
                    <small class="form-text text-muted">0 = ignorata</small>
                </div>
            </div>
            <div class="form-row mt-2">
                <div class="form-group col-md-3">
                    <label for="riskFree">Risk-free (%) (per calcolo Sharpe)</label>
                    <input type="number" class="form-control" id="riskFree" value="0.5" step="0.01">
                    <small class="form-text text-muted">Tasso risk-free annuo (es. 0.5 = 0.5%)</small>
                </div>
            </div>
        </form>
        <!-- Grafico WINC vs SP500 -->
        <div class="chart-container">
            <canvas id="xyleChart"></canvas>
        </div>
        <p class="small text-muted mt-2">Legenda:
        <ul>
            <li><strong>Rige verdi</strong> = Date di stacco dividendi WINC</li>
            <li><strong>ACWE Accumulo</strong> = ACWE (con aggiustamento dividendi), </li>
            <li><strong>WINC Accumulo</strong> = WINC con reinvestimento dividendi, </li>
            <li><strong>WINC Distribuzione</strong> = WINC senza reinvestimento dei dividendi.</li>
            <li><strong>ACWE con vendite</strong> = ACWE con vendite per coprire i dividendi di WINC (va confrontato
                con la riga arancione).</li>
        </ul>
        </p>
        <div class="mt-4" id="metricsContainer">
            <h4 class="text-center mb-3">Metriche Serie</h4>
            <div class="row g-2">
                <div class="col-md-6 col-lg-3 pb-1">
                    <div class="metric-card"
                        style="background: linear-gradient(135deg, rgba(54,162,235,0.1) 0%, rgba(54,162,235,0.05) 100%); border-left: 4px solid rgba(54,162,235,0.8);">
                        <strong style="color: #3693eb; font-size: 0.95rem;">ACWE - Accumulo</strong>
                        <div id="metrics-acwe" class="metric-value" style="font-size: 0.85rem; line-height: 1.4;">
                            Calcolo in corso...</div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3 pb-1">
                    <div class="metric-card"
                        style="background: linear-gradient(135deg, rgba(40,167,69,0.1) 0%, rgba(40,167,69,0.05) 100%); border-left: 4px solid rgba(40,167,69,0.8);">
                        <strong style="color: #28a745; font-size: 0.95rem;">WINC - Total Return</strong>
                        <div id="metrics-winc" class="metric-value" style="font-size: 0.85rem; line-height: 1.4;">
                            Calcolo in corso...</div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3 pb-1">
                    <div class="metric-card"
                        style="background: linear-gradient(135deg, rgba(75,192,192,0.1) 0%, rgba(75,192,192,0.05) 100%); border-left: 4px solid rgba(75,192,192,0.8);">
                        <strong style="color: #20b2aa; font-size: 0.95rem;">ACWE - Con Vendite</strong>
                        <div id="metrics-acwe-sold" class="metric-value" style="font-size: 0.85rem; line-height: 1.4;">
                            Calcolo in corso...</div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="metric-card"
                        style="background: linear-gradient(135deg, rgba(255,159,64,0.1) 0%, rgba(255,159,64,0.05) 100%); border-left: 4px solid rgba(255,159,64,0.8);">
                        <strong style="color: #ff9f40; font-size: 0.95rem;">WINC - Netto</strong>
                        <div id="metrics-winc-netto" class="metric-value" style="font-size: 0.85rem; line-height: 1.4;">
                            Calcolo in corso...</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container mt-4">
            <h3 class="text-center">Tabella Dividendi</h3>

            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>Data di Stacco</th>
                            <th>Dividendo Lordo WINC (‚Ç¨)</th>
                            <th>Dividendo Netto WINC (‚Ç¨)</th>
                            <th>Quote ACWE Vendute</th>
                            <th>Dividendo Lordo ACWE (da vendita) (‚Ç¨)</th>
                            <th>Dividendo Netto ACWE (da vendita) (‚Ç¨)</th>
                            <th>Differenza tra i netti</th>
                        </tr>
                    </thead>
                    <tbody id="dividendiTableBody">
                    </tbody>
                    <tfoot id="dividendiTableFoot">
                    </tfoot>
                </table>
            </div>
        </div>


        <div class="chart-container mt-3" style="height:320px;">
            <canvas id="taxComparisonChart"></canvas>
        </div>
        <!-- Sezione statica per Tax Metrics e grafico confronto netti -->
        <div id="taxCardsContainer" class="mt-4">
            <h4 class="text-center mb-3">Impatto Fiscale</h4>
            <div class="row g-3">
                <div class="col-md-6 pb-1">
                    <div class="metric-card"
                        style="background: linear-gradient(135deg, rgba(40,167,69,0.1) 0%, rgba(40,167,69,0.05) 100%); border-left: 4px solid rgba(40,167,69,0.8);">
                        <strong style="color: #28a745;">WINC - Tax Metrics</strong>
                        <div class="metric-value" style="font-size: 0.9rem; line-height: 1.6;">
                            <div>Tax Drag: <span id="wincTaxDrag" style="font-weight: bold; color: #dc3545;">n/a</span>
                            </div>
                            <div>Tax Efficiency: <span id="wincTaxEff"
                                    style="font-weight: bold; color: #28a745;">n/a</span></div>
                            <hr style="margin: 6px 0;">
                            <div>Lordo: <span id="wincLordoTot" style="font-weight: bold;">0.00</span> ‚Ç¨</div>
                            <div>Netto: <span id="wincNettoTot" style="font-weight: bold; color: #28a745;">0.00</span> ‚Ç¨
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="metric-card"
                        style="background: linear-gradient(135deg, rgba(54,162,235,0.1) 0%, rgba(54,162,235,0.05) 100%); border-left: 4px solid rgba(54,162,235,0.8);">
                        <strong style="color: #3693eb;">ACWE (con vendite) - Tax Metrics</strong>
                        <div class="metric-value" style="font-size: 0.9rem;">
                            <div>Tax Drag: <span id="acweTaxDrag" style="font-weight: bold; color: #dc3545;">n/a</span>
                            </div>
                            <div>Tax Efficiency: <span id="acweTaxEff"
                                    style="font-weight: bold; color: #28a745;">n/a</span></div>
                            <hr style="margin: 6px 0;">
                            <div>Lordo: <span id="acweLordoTot" style="font-weight: bold;">0.00</span> ‚Ç¨</div>
                            <div>Netto: <span id="acweNettoTot" style="font-weight: bold; color: #3693eb;">0.00</span> ‚Ç¨
                            </div>
                            <div>Comm: <span id="acweCommissioniTot" style="font-weight: bold;">0.00</span>‚Ç¨</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <section id="approfondimento-arbitraggio" style="margin-top:1.5rem;padding-top:1rem;">
            <h3>Assenza di arbitraggio e calibrazione implicita del premio delle call</h3>

            <p>
                Un risultato interessante emerso dall‚Äôanalisi √® che la quantit√† di valore estratto tramite la vendita di
                call
                sembra ‚Äúcalibrata‚Äù per mantenere il capitale del sottostante sostanzialmente costante nel lungo periodo.
                Questa non √® una coincidenza: deriva direttamente dal <strong>principio di assenza di
                    arbitraggio</strong>, che √® alla base
                dell‚Äôintero pricing delle opzioni.
            </p>

            <p>
                Il premio di una call non pu√≤ essere superiore al valore atteso dell‚Äôupside che l‚Äôinvestitore rinuncia
                oltre lo strike.
                In misura risk‚Äìneutral questo valore √® dato da:
            </p>

            <p style="text-align:center;">
                $$ C = e^{-rT}\,\mathbb{E}^{\mathbb{Q}}[(S_T - K)^+] $$
            </p>

            <p>
                Se fosse possibile ottenere con una covered call un premio sistematicamente maggiore della crescita
                attesa del sottostante,
                allora un investitore potrebbe costruire una strategia di arbitraggio priva di rischio:
                acquistare il sottostante, vendere call ‚Äútroppo care‚Äù e coprirsi con strumenti lineari.
                Questo genererebbe un profitto certo e immediato, il che violerebbe l‚Äôassunzione fondamentale dei
                mercati
                finanziari efficienti.
            </p>

            <p>
                Il mercato quindi ‚Äúimpone‚Äù che:
            </p>

            <p style="text-align:center;">
                $$ \text{Valore estratto via call} \;\approx\; \text{upside ceduto} $$
            </p>

            <p>
                Per questo motivo, la distribuzione ottenuta vendendo call non pu√≤ superare ci√≤ che si otterrebbe
                vendendo in modo dinamico
                le quote del sottostante: il premio √® <strong>tarato</strong> per riflettere esattamente il valore della
                crescita futura ceduta.
                Allo stesso modo, estrarre pi√π valore del premio equivarrebbe a vendere ‚Äútroppo‚Äù del sottostante,
                portando inevitabilmente
                a una riduzione progressiva del capitale.
            </p>
        </section>

        <section id="riassunto-covered-call" style="margin-top:1.5rem;border-top:1px solid #ddd;padding-top:1rem;">
            <h3>Conclusioni</h3>
            <p>
                <strong>Il rendimento di una strategia covered call non pu√≤ superare il rendimento ottenibile liquidando
                    dinamicamente il sottostante, a parit√† di rischio, perch√© il prezzo dell‚Äôopzione incorpora gi√† tutta
                    l‚Äôinformazione sul sottostante.</strong>
            </p>

            <p>
                Vendere una call coperta equivale a monetizzare oggi una parte del potenziale upside futuro.
                Allo stesso modo, vendere progressivamente una quota del sottostante fornisce liquidit√† immediata in
                cambio di una riduzione proporzionale della partecipazione alla crescita futura.
                Il premio della call rappresenta quindi il valore atteso dell‚Äôupside ceduto: questo crea una relazione
                strutturale tra covered call e liquidazione dinamica del sottostante.
            </p>

            <div style="background:#f9f9f9;border:1px solid #eee;padding:0.8rem;border-radius:6px;">
                <h4 style="margin:0 0 0.6rem 0;">Formule essenziali</h4>

                <p><em>Posizione covered call:</em></p>
                <p>
                    $$ \text{Covered Call} = S_0 - C $$
                </p>

                <p><em>Payoff a scadenza:</em></p>
                <p>
                    $$ \text{Payoff}_{CC}(T) = S_T - \max(S_T - K, 0) = \min(S_T, K) $$
                </p>

                <p><em>Prezzo della call (misura risk-neutral):</em></p>
                <p>
                    $$ C = e^{-rT}\,\mathbb{E}^{\mathbb{Q}}[(S_T - K)^+] $$
                </p>

                <p><em>Strategia equivalente tramite vendita dinamica di sottostante:</em></p>
                <p>
                    Occorre vendere una quota \( q \) del sottostante tale che:
                    $$ q S_0 = C $$
                    quindi la posizione diventa:
                    $$ \text{Synthetic} = (1 - q) S_0. $$
                </p>

                <p><em>Equivalenza dei valori iniziali:</em></p>
                <p>
                    $$ \text{Covered Call}(0) = S_0 - C $$
                    $$ \text{Synthetic}(0) = S_0 - q S_0 $$
                    Imponendo \( q S_0 = C \) segue direttamente:
                    $$ \text{Covered Call}(0) = \text{Synthetic}(0). $$
                </p>
            </div>

            <p>
                <strong>Interpretazione pratica:</strong> il premio della call √® pari al valore atteso dell‚Äôupside che
                si rinuncia oltre lo strike.
                Nessuna strategia covered call pu√≤ generare un rendimento superiore a quello ottenibile vendendo
                dinamicamente il sottostante con lo stesso profilo di rischio; se lo facesse, esisterebbe un arbitraggio
                e i prezzi delle opzioni si adeguerebbero immediatamente.
            </p>

            <p>
                Nella pratica reale possono emergere differenze dovute a tassazione, costi di transazione, frequenza
                delle vendite e limiti di frazionamento, ma la relazione teorica di fondo resta valida: la covered call
                non crea rendimento aggiuntivo, lo anticipa e lo redistribuisce nel tempo.
            </p>
        </section>

    </div>
    </div>
    <script>
        window.MathJax = {
            tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]] },
            svg: { fontCache: "global" }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <!-- Disclaimer -->
    <div id="disclaimer-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetch('../html/disclaimer.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('disclaimer-container').innerHTML = data;
                });
        });
    </script>
    <script>
        async function loadAndPlot() {
            const initialCapital = parseFloat(document.getElementById('montante').value);
            const modalita = parseFloat(modalitaSelect.value);
            const sellCommissionType = document.getElementById('sellCommissionType').value || 'euro';
            const sellCommission = parseFloat(document.getElementById('sellCommission').value) || 7; // Commissione di vendita in euro (flat)
            const sellCommissionPercent = parseFloat(document.getElementById('sellCommissionPercent').value) || 0.2; // percentuale (es. 0.2 = 0.2%)
            const sellCommissionMin = parseFloat(document.getElementById('sellCommissionMin').value) || 0; // minima in euro
            const sellCommissionMax = parseFloat(document.getElementById('sellCommissionMax').value) || 0; // massima in euro
            const riskFreePercent = parseFloat(document.getElementById('riskFree').value);
            const riskFreeAnnual = !isNaN(riskFreePercent) ? (riskFreePercent / 100) : 0.005; // default 0.5% se non valido
            try {
                const [xyleResp, csspxResp, distribuzioniResp, cambioEurUsdResp] = await Promise.all([
                    fetch('WINC.DE.json'),
                    fetch('ACWE.MI.json'),
                    fetch('Distribuzioni_WINC.txt'),
                    fetch('cambio_eur_usd.json')
                ]);

                if (!xyleResp.ok || !csspxResp.ok || !distribuzioniResp.ok || !cambioEurUsdResp.ok) throw new Error('Impossibile caricare i file JSON o il file delle distribuzioni.');

                let [xyleRaw, csspxRaw, distribuzioniRaw, cambioEurUsdRaw] = await Promise.all([
                    xyleResp.json(),
                    csspxResp.json(),
                    distribuzioniResp.text(),
                    cambioEurUsdResp.json()
                ]);

                const startDateInput = document.getElementById('startDate');
                var startDateValue = startDateInput.value;
                if (!startDateValue) {
                    startDateInput.value = xyleRaw[0].Date;
                }
                const startDate = startDateInput.value;
                if (startDate > xyleRaw[xyleRaw.length - 1].Date) {
                    return;
                }

                // Filtra i dati in base alla data di inizio selezionata
                xyleRaw = xyleRaw.filter(item => new Date(item.Date) >= new Date(startDate));
                csspxRaw = csspxRaw.filter(item => new Date(item.Date) >= new Date(startDate));

                let distribuzioni = [];
                // Parsing distribuzioni
                distribuzioni = distribuzioniRaw.split('\n').slice(1).map(line => {
                    const parts = line.split('\t');
                    if (parts.length < 2) return null; // Salta righe malformate

                    const data = parts[0]?.trim();
                    const importo = parts[1]?.replace('‚Ç¨', '').trim();

                    if (!data || isNaN(parseFloat(importo))) return null; // Salta righe con dati mancanti

                    // Converti data da giorno-mese-anno a anno-mese-giorno
                    const [day, month, year] = data.split('-');
                    const formattedDate = `${year}-${month}-${day}`;

                    return {
                        date: formattedDate,
                        amount: parseFloat(importo)
                    };
                }).filter(Boolean)
                    .filter(dist => new Date(dist.date) >= new Date(startDate)); // Rimuove eventuali null

                // mappa data->valori
                const mapXYLE = new Map();
                xyleRaw.forEach(item => {
                    if (!item.Date) return;
                    mapXYLE.set(item.Date, { adj: item.AdjClose ?? null, close: item.Close ?? null });
                });

                const mapCSSPX = new Map();
                csspxRaw.forEach(item => {
                    if (!item.Date) return;
                    mapCSSPX.set(item.Date, { adj: item.AdjClose ?? null });
                });

                const mapCambio = new Map();
                cambioEurUsdRaw.forEach(item => {
                    if (!item.Date) return;
                    mapCambio.set(item.Date, { cambio: item.Close ?? null });
                });

                // unione delle date
                const dateSet = new Set([...mapXYLE.keys(), ...mapCSSPX.keys()]);
                const labels = Array.from(dateSet).sort((a, b) => new Date(a) - new Date(b));

                const csspxAdjSeries = [];
                const xyleAdjSeries = [];
                const xyleCloseSeries = [];

                // Calcolo valore cumulativo
                let csspxInitialPrice = mapCSSPX.size ? mapCSSPX.get([...mapCSSPX.keys()].sort((a, b) => new Date(a) - new Date(b))[0]).adj : null;
                let xyleAdjInitialPrice = mapXYLE.size ? mapXYLE.get([...mapXYLE.keys()].sort((a, b) => new Date(a) - new Date(b))[0]).adj : null;
                let xyleCloseInitialPrice = mapXYLE.size ? mapXYLE.get([...mapXYLE.keys()].sort((a, b) => new Date(a) - new Date(b))[0]).close : null;

                const csspxCumulative = [];
                const xyleAdjCumulative = [];
                const xyleCloseCumulative = [];
                const distribuzioniCSSPXVirtuali = []

                // Nuova serie CSSPX con vendite
                const csspxAdjustedCumulative = [];
                let csspxShares = modalita > 0 ? initialCapital / csspxInitialPrice : Math.floor(initialCapital / csspxInitialPrice); // Calcola il numero iniziale di quote di CSSPX
                const xyleShares = modalita > 0 ? initialCapital / xyleCloseInitialPrice : Math.floor(initialCapital / xyleCloseInitialPrice); // Calcola il numero iniziale di quote di XYLE

                labels.forEach(d => {
                    const c = mapCSSPX.get(d);
                    const x = mapXYLE.get(d);

                    const csspxAdj = c ? Number(c.adj) : null;
                    const xyleAdj = x ? Number(x.adj) : null;
                    const xyleClose = x ? Number(x.close) : null;

                    // Imposta i prezzi iniziali
                    if (csspxAdj != null && csspxInitialPrice == null) csspxInitialPrice = csspxAdj;
                    if (xyleAdj != null && xyleAdjInitialPrice == null) xyleAdjInitialPrice = xyleAdj;
                    if (xyleClose != null && xyleCloseInitialPrice == null) xyleCloseInitialPrice = xyleClose;

                    // Calcola valore cumulativo
                    csspxCumulative.push(csspxInitialPrice != null && csspxAdj != null ? (initialCapital / csspxInitialPrice) * csspxAdj : null);
                    xyleAdjCumulative.push(xyleAdjInitialPrice != null && xyleAdj != null ? (initialCapital / xyleAdjInitialPrice) * xyleAdj : null);
                    xyleCloseCumulative.push(xyleCloseInitialPrice != null && xyleClose != null ? (initialCapital / xyleCloseInitialPrice) * xyleClose : null);
                });

                // Calcolo serie con vendite CSSPX
                csspxShares = modalita > 0 ? initialCapital / csspxInitialPrice : Math.floor(initialCapital / csspxInitialPrice); // Reset numero quote CSSPX
                labels.forEach(d => {
                    const c = mapCSSPX.get(d);
                    const x = mapXYLE.get(d);

                    const csspxAdj = c ? Number(c.adj) : null;
                    const xyleAdj = x ? Number(x.adj) : null;
                    const xyleClose = x ? Number(x.close) : null;

                    // Calcola dividendo totale di XYLE in questa data
                    const distribuzione = distribuzioni.find(dist => dist.date === d);
                    if (distribuzione && csspxAdj != null) {
                        const totalDividend = distribuzione.amount * xyleShares; // Dividendo totale
                        const sharesToSell = modalita > 0 ? (totalDividend / csspxAdj) : Math.ceil(totalDividend / csspxAdj);
                        csspxShares -= sharesToSell; // Aggiorna il numero di quote di CSSPX
                        // Calcola commissione in euro: o flat per operazione, o percentuale sul valore della vendita
                        const saleValue = sharesToSell * csspxAdj;
                        let commissionPerSale = 0;
                        if (sellCommissionType === 'percent') {
                            commissionPerSale = (sellCommissionPercent / 100) * saleValue;
                            // Applica soglie min/max se almeno una √® > 0; se entrambe = 0 vengono ignorate
                            if (!(sellCommissionMin === 0 && sellCommissionMax === 0)) {
                                if (sellCommissionMin > 0) commissionPerSale = Math.max(commissionPerSale, sellCommissionMin);
                                if (sellCommissionMax > 0) commissionPerSale = Math.min(commissionPerSale, sellCommissionMax);
                            }
                        } else {
                            commissionPerSale = sellCommission;
                        }
                        distribuzioniCSSPXVirtuali.push({ date: d, num_stock_selled: sharesToSell, csspxValueAtDate: csspxAdj, amount: saleValue, xyle_value: xyleClose, commission: commissionPerSale }); // Valore vendite
                    }

                    csspxAdjustedCumulative.push(csspxAdj != null ? csspxShares * csspxAdj : null);
                });

                const annotations = distribuzioni.map(dist => ({
                    type: 'line',
                    scaleID: 'x',
                    value: dist.date,
                    borderColor: 'rgba(0, 255, 0, 0.7)',
                    borderWidth: 1,
                    label: {
                        content: 'Dividendo',
                        enabled: false,
                        position: 'top'
                    }
                }));

                annotations.push({
                    type: 'line',
                    scaleID: 'y',
                    value: initialCapital,
                    borderColor: 'rgba(255, 0, 0, 0.7)',
                    borderWidth: 1,
                    label: {
                        content: 'Capitale Iniziale',
                        enabled: false,
                        position: 'top'
                    }
                });


                populateDividendiTable(distribuzioni, xyleShares, csspxShares, csspxInitialPrice, mapCSSPX, distribuzioniCSSPXVirtuali, mapCambio);



                const ctx = document.getElementById('xyleChart').getContext('2d');
                // distrugge eventuale chart precedente
                if (window._xyleChart) {
                    window._xyleChart.destroy();
                }

                window._xyleChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '(ACWE) - Accumulo',
                                data: csspxCumulative,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                spanGaps: true,
                                tension: 0.2,
                                borderWidth: 2,
                                pointRadius: 0
                            },
                            {
                                label: 'WINC - Accumulo (reinvestimento dividendi lordi)',
                                data: xyleAdjCumulative,
                                borderColor: 'rgba(40, 167, 69, 1)',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                spanGaps: true,
                                tension: 0.2,
                                borderWidth: 2,
                                pointRadius: 0
                            },
                            {
                                label: 'WINC - Distribuzione (senza reinvestimento dividendi)',
                                data: xyleCloseCumulative,
                                borderColor: 'rgba(255, 159, 64, 1)',
                                backgroundColor: 'rgba(255, 159, 64, 0.08)',
                                spanGaps: true,
                                tension: 0.2,
                                borderWidth: 2,
                                pointRadius: 0
                            },
                            {
                                label: 'ACWE (con vendite equivalenti ai dividendi WINC)',
                                data: csspxAdjustedCumulative,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                spanGaps: true,
                                tension: 0.2,
                                borderWidth: 2,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'WINC vs ACWE'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const v = context.raw;
                                        return context.dataset.label + ': ' + (v == null ? 'n/a' : v.toFixed(2) + ' $');
                                    }
                                }
                            },
                            annotation: {
                                annotations: annotations
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Date' },
                                ticks: {
                                    maxRotation: 90,
                                    autoSkip: true,
                                    maxTicksLimit: 12
                                },
                                grid: {
                                    display: false // Disabilita le linee verticali di sfondo
                                }
                            },
                            y: {
                                title: { display: true, text: 'Valore ($)' },
                                beginAtZero: false
                            }
                        }
                    }
                });

                // Calcola metriche (deviazione standard annualizzata e Sharpe annualizzato)
                // rfAnnual deve essere espresso in decimale (es. 0.005 = 0.5%)
                function computeMetrics(series, labels, rfAnnual = 0) {
                    const returns = [];
                    const days = [];
                    let lastVal = null;
                    let lastDate = null;
                    for (let i = 0; i < labels.length; i++) {
                        const v = series[i];
                        const d = labels[i];
                        if (v == null || lastVal == null) {
                            lastVal = v;
                            lastDate = d;
                            continue;
                        }
                        if (lastVal === 0) {
                            lastVal = v;
                            lastDate = d;
                            continue;
                        }
                        const r = v / lastVal - 1;
                        returns.push(r);
                        const dayDiff = (new Date(d) - new Date(lastDate)) / (1000 * 3600 * 24);
                        days.push(dayDiff);
                        lastVal = v;
                        lastDate = d;
                    }

                    if (returns.length === 0) return { stdAnn: NaN, sharpe: NaN, periodsPerYear: NaN };

                    const n = returns.length;
                    const mean = returns.reduce((a, b) => a + b, 0) / n;
                    // sample standard deviation
                    let variance = 0;
                    if (n > 1) {
                        variance = returns.map(r => (r - mean) * (r - mean)).reduce((a, b) => a + b, 0) / (n - 1);
                    } else {
                        variance = 0;
                    }
                    const std = Math.sqrt(variance);

                    // stima giorni medi tra osservazioni
                    const avgDays = days.length ? (days.reduce((a, b) => a + b, 0) / days.length) : 365;
                    const periodsPerYear = avgDays > 0 ? 365 / avgDays : 1;

                    // annualizza media e deviazione (usando approccio aritmetico)
                    const meanAnn = mean * periodsPerYear;
                    const stdAnn = std * Math.sqrt(periodsPerYear);
                    const rfAnn = rfAnnual || 0;
                    const rfPeriod = rfAnn / periodsPerYear;
                    const sharpe = stdAnn > 0 ? ((meanAnn - rfAnn) / stdAnn) : NaN;
                    const periodSharpe = std > 0 ? ((mean - rfPeriod) / std) : NaN; // Sharpe base periodale sull'intero periodo corretto per rf
                    return { stdAnn: stdAnn, sharpe: sharpe, periodsPerYear: periodsPerYear, periodSharpe: periodSharpe };
                }

                function fmt(x) {
                    if (isNaN(x) || x === null) return 'n/a';
                    return (x * 100).toFixed(2) + '%';
                }

                const mAcwe = computeMetrics(csspxCumulative, labels, riskFreeAnnual);
                const mAcweSold = computeMetrics(csspxAdjustedCumulative, labels, riskFreeAnnual);
                const mWinc = computeMetrics(xyleAdjCumulative, labels, riskFreeAnnual);
                const mWincNetto = computeMetrics(xyleCloseCumulative, labels, riskFreeAnnual);

                document.getElementById('metrics-acwe').innerText = `Dev.std (ann): ${fmt(mAcwe.stdAnn)}\nSharpe (ann): ${isNaN(mAcwe.sharpe) ? 'n/a' : mAcwe.sharpe.toFixed(3)}\nSharpe (periodale): ${isNaN(mAcwe.periodSharpe) ? 'n/a' : mAcwe.periodSharpe.toFixed(3)}`;
                document.getElementById('metrics-acwe-sold').innerText = `Dev.std (ann): ${fmt(mAcweSold.stdAnn)}\nSharpe (ann): ${isNaN(mAcweSold.sharpe) ? 'n/a' : mAcweSold.sharpe.toFixed(3)}\nSharpe (periodale): ${isNaN(mAcweSold.periodSharpe) ? 'n/a' : mAcweSold.periodSharpe.toFixed(3)}`;
                document.getElementById('metrics-winc').innerText = `Dev.std (ann): ${fmt(mWinc.stdAnn)}\nSharpe (ann): ${isNaN(mWinc.sharpe) ? 'n/a' : mWinc.sharpe.toFixed(3)}\nSharpe (periodale): ${isNaN(mWinc.periodSharpe) ? 'n/a' : mWinc.periodSharpe.toFixed(3)}`;
                document.getElementById('metrics-winc-netto').innerText = `Dev.std (ann): ${fmt(mWincNetto.stdAnn)}\nSharpe (ann): ${isNaN(mWincNetto.sharpe) ? 'n/a' : mWincNetto.sharpe.toFixed(3)}\nSharpe (periodale): ${isNaN(mWincNetto.periodSharpe) ? 'n/a' : mWincNetto.periodSharpe.toFixed(3)}`;

            } catch (err) {
                console.error(err);
                const container = document.getElementById('disclaimer-container');
                const msg = document.createElement('div');
                msg.className = 'alert alert-warning mt-3';
                msg.innerHTML = '<strong>Attenzione:</strong> impossibile caricare i file JSON localmente. Se stai aprendo il file via <code>file://</code>, prova a servire la cartella con un server HTTP (es. <code>python -m http.server</code> dalla root del progetto) e ricarica la pagina.';
                container.appendChild(msg);
            }
        }

        function populateDividendiTable(distribuzioni, xyleShares, csspxShares, csspxInitialPrice, mapCSSPX, distribuzioniCSSPXVirtuali, mapCambio) {
            const tableBody = document.getElementById('dividendiTableBody');
            tableBody.innerHTML = '';
            let sommaNettiXyle = 0;
            let sommaLordoXyle = 0;
            let sommaNettiSp500 = 0;
            let sommaLordiSp500 = 0;
            let sommaDifferenza = 0;
            let sommaCommissioni = 0;

            // raccolte per il grafico di confronto
            const chartLabels = [];
            const nettoWincSeries = [];
            const nettoAcweSeries = [];

            distribuzioni.forEach(dist => {
                const { date, amount } = dist;
                const cambioAlGiorno = mapCambio.get(dist.date).cambio;
                const distribuzioneCSSPX = distribuzioniCSSPXVirtuali.find(d => d.date === date);
                // Calcolo dividendi XYLE
                const lordoXYLE = amount * xyleShares;
                const nettoXYLE = lordoXYLE * 0.74; // Tassazione 26%
                sommaLordoXyle += lordoXYLE;
                // push per grafico
                chartLabels.push(date);
                nettoWincSeries.push(Number(nettoXYLE.toFixed(2)));
                const percentualeDist = (nettoXYLE / xyleShares / (distribuzioneCSSPX.xyle_value / cambioAlGiorno)) * 100;
                const quoteSp500Vendute = distribuzioneCSSPX ? distribuzioneCSSPX.num_stock_selled : 0;
                const lordoVenduto = distribuzioneCSSPX ? distribuzioneCSSPX.amount : 0;
                const commission = distribuzioneCSSPX ? (distribuzioneCSSPX.commission || 0) : 0;
                // Calcolo plusvalenza tassabile: (prezzo vendita - prezzo carico) * n_quote - commissioni
                const plusvalenzaPerQuota = distribuzioneCSSPX ? (distribuzioneCSSPX.csspxValueAtDate - csspxInitialPrice) : 0;
                const totalePlusvalenza = (plusvalenzaPerQuota > 0 && distribuzioneCSSPX) ? plusvalenzaPerQuota * distribuzioneCSSPX.num_stock_selled : 0;
                const taxableGain = Math.max(0, totalePlusvalenza - commission);
                const tassePagate = taxableGain * 0.26;
                const nettoSp500 = lordoVenduto - tassePagate - commission;
                nettoAcweSeries.push(Number(nettoSp500.toFixed(2)));
                const percentualeTasse = lordoVenduto > 0 ? (tassePagate / lordoVenduto) * 100 : 0;

                // Crea riga tabella
                const row = document.createElement('tr');
                row.innerHTML = `
                        <td>${date}</td>
                        <td>${lordoXYLE.toFixed(2)}</td>                        
                        <td>${nettoXYLE.toFixed(2)} Tasse: 26% (=${percentualeDist.toFixed(2)}%)</td>                        
                        <td>${quoteSp500Vendute}</td>
                        <td>${lordoVenduto.toFixed(2)}</td>
                        <td>${nettoSp500.toFixed(2)} Tasse: ${percentualeTasse.toFixed(2)}% Comm: ${commission.toFixed(2)}‚Ç¨</td>
                        <td>${(nettoSp500 - nettoXYLE).toFixed(2)}  (${(((nettoSp500 - nettoXYLE) / nettoXYLE) * 100).toFixed(2)}%)</td>
                    `;
                tableBody.appendChild(row);
                sommaDifferenza += nettoSp500 - nettoXYLE;
                sommaNettiSp500 += nettoSp500;
                sommaLordiSp500 += lordoVenduto;
                sommaNettiXyle += nettoXYLE;
                sommaCommissioni += commission;
            });

            const tableFoot = document.getElementById('dividendiTableFoot');
            tableFoot.innerHTML = '';
            const row = document.createElement('tr');
            // Calcola Tax Drag e Tax Efficiency per le due strategie
            const taxDragWinc = sommaLordoXyle > 0 ? (sommaLordoXyle - sommaNettiXyle) / sommaLordoXyle : NaN;
            const taxEffWinc = sommaLordoXyle > 0 ? sommaNettiXyle / sommaLordoXyle : NaN;

            const taxDragAcwe = sommaLordiSp500 > 0 ? (sommaLordiSp500 - sommaNettiSp500) / sommaLordiSp500 : NaN;
            const taxEffAcwe = sommaLordiSp500 > 0 ? sommaNettiSp500 / sommaLordiSp500 : NaN;

            // Aggiorna i campi delle card statiche (non ricrearle dinamicamente)
            const setText = (id, text) => { const el = document.getElementById(id); if (el) el.innerText = text; };
            setText('wincTaxDrag', isNaN(taxDragWinc) ? 'n/a' : (taxDragWinc * 100).toFixed(2) + '%');
            setText('wincTaxEff', isNaN(taxEffWinc) ? 'n/a' : (taxEffWinc * 100).toFixed(2) + '%');
            setText('wincLordoTot', sommaLordoXyle.toFixed(2));
            setText('wincNettoTot', sommaNettiXyle.toFixed(2));

            setText('acweTaxDrag', isNaN(taxDragAcwe) ? 'n/a' : (taxDragAcwe * 100).toFixed(2) + '%');
            setText('acweTaxEff', isNaN(taxEffAcwe) ? 'n/a' : (taxEffAcwe * 100).toFixed(2) + '%');
            setText('acweLordoTot', sommaLordiSp500.toFixed(2));
            setText('acweNettoTot', sommaNettiSp500.toFixed(2));
            setText('acweCommissioniTot', sommaCommissioni.toFixed(2));
            row.innerHTML = `
                        <td>Tot:</td>
                        <td></td>                        
                        <td>${sommaNettiXyle.toFixed(2)} Tasse: 26%</td>                        
                        <td></td>
                        <td></td>
                        <td>${sommaNettiSp500.toFixed(2)} Tasse: ${sommaLordiSp500 > 0 ? ((sommaLordiSp500 - sommaNettiSp500) / sommaLordiSp500 * 100).toFixed(2) : '0.00'}% (Commissioni Tot: ${sommaCommissioni.toFixed(2)}‚Ç¨)</td>
                        <td>${sommaDifferenza.toFixed(2)} (${(((sommaNettiSp500 - sommaNettiXyle) / sommaNettiXyle) * 100).toFixed(2)}%)</td>
                    `;
            tableFoot.appendChild(row);

            // Aggiorna o crea il grafico usando il canvas statico
            const ctxEl = document.getElementById('taxComparisonChart');
            if (ctxEl) {
                const ctx2 = ctxEl.getContext('2d');
                if (window._taxComparisonChart) {
                    window._taxComparisonChart.data.labels = chartLabels;
                    window._taxComparisonChart.data.datasets[0].data = nettoWincSeries;
                    window._taxComparisonChart.data.datasets[1].data = nettoAcweSeries;
                    window._taxComparisonChart.update();
                } else {
                    window._taxComparisonChart = new Chart(ctx2, {
                        type: 'bar',
                        data: {
                            labels: chartLabels,
                            datasets: [
                                { label: 'Dividendi netti WINC (‚Ç¨)', data: nettoWincSeries, backgroundColor: 'rgba(40,167,69,0.8)' },
                                { label: 'Vendite ACWE - netto (‚Ç¨)', data: nettoAcweSeries, backgroundColor: 'rgba(54,162,235,0.8)' }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            scales: {
                                x: { title: { display: true, text: 'Date' }, ticks: { maxRotation: 90, autoSkip: true, maxTicksLimit: 12 } },
                                y: { beginAtZero: true, title: { display: true, text: '‚Ç¨' } }
                            },
                            plugins: { legend: { position: 'top' } }
                        }
                    });
                }
            }
        }

        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', loadAndPlot);
        });
        document.addEventListener('DOMContentLoaded', loadAndPlot);
        const modalitaSelect = document.getElementById('modalita');
        modalitaSelect.addEventListener('change', loadAndPlot);
        const startDateInput = document.getElementById('startDate');
        startDateInput.addEventListener('change', loadAndPlot);
        const sellCommissionTypeSelect = document.getElementById('sellCommissionType');
        const sellCommissionPercentGroup = document.getElementById('sellCommissionPercentGroup');
        // Mostra/nascondi campo percentuale e min/max in base al tipo selezionato
        sellCommissionTypeSelect.addEventListener('change', function () {
            loadAndPlot();
        });
        // Rerun on min/max changes
        const sellCommissionMin = document.getElementById('sellCommissionMin');
        const sellCommissionMax = document.getElementById('sellCommissionMax');
        if (sellCommissionMin) sellCommissionMin.addEventListener('input', loadAndPlot);
        if (sellCommissionMax) sellCommissionMax.addEventListener('input', loadAndPlot);
    </script>
</body>

</html>