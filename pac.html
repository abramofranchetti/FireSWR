<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <title>PAC SIMULATOR
    </title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
    <!-- Chart.js Zoom Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.0.0"></script>
    <style>
        body {
            padding-top: 20px;
        }

        .box {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .container {
            max-width: 1600px;
            margin: auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            text-align: center;
            color: #333;
        }

        /* Stile per il disclaimer */
        .disclaimer {
            font-size: 0.9em;
            color: #666;
            border-top: 1px solid #ddd;
            padding-top: 15px;
            margin-top: 30px;
            line-height: 1.4;
        }

        .disclaimer strong {
            font-weight: bold;
        }

        .home-button {
            text-decoration: none;
            color: #ffffff;
            background-color: #0073e6;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .istruzioni {
            background-color: #333;
            color: #fff;
            text-align: left;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
        }

        .home-button:hover {
            background-color: #ebf3fc;
        }
    </style>
</head>

<body>
    <div class="container">
        <div>
            <a href="/" class="home-button">üè† Home</a>
        </div>
        <br>
        <h1 class="mt-4 mb-4">Simulazione Piano di Accumulo Storico</h1>
        <h3 class="text-center">Con dati Storici Reali e gestione cambio ‚Ç¨/$ storico</h3>
        <div class="istruzioni">
            <p>
                Questo calcolatore ti consente di simulare un piano di accumulo nel tempo utilizzando <strong>dati
                    storici reali</strong> dell'indice selezionato.
                Puoi impostare il capitale iniziale, il versamento mensile, il costo annuale (TER)
                e
                le date di inizio e fine della simulazione. Il grafico mostra l'evoluzione del capitale lordo, netto e
                nettissimo
                (dopo tassazione delle plusvalenze al 26%). I risultati finali includono i valori lordo, netto e
                nettissimo alla
                data di fine, nonch√© le differenze rispetto al valore lordo.
                <br>
                Selezionare una data tra quelle disponibili nello storico del relativo indice.
                <br>
                <strong>Per Lordo si intente il rendimento senza spese e tasse, per Netto si intende il rendimento dopo
                    l'applicazione del TER e Nettissimo √® il risultato netto dopo l'applicazione della tassazione del
                    26% sul guadagno. </strong>
            </p>
        </div>
        <br>

        <!-- Form di input -->
        <form id="simulationForm" class="mb-4">
            <div class="form-row">
                <div class="form-group col-md-3">
                    <label for="indexSelect">Seleziona Indice:</label>
                    <select class="form-control" id="indexSelect" required>
                        <option value="acwi">ACWI (All Country World Index)</option>
                        <option value="sp500">SP500 TR</option>
                    </select>
                </div>
                <div class="form-group col-md-3">
                    <label for="initialCapitalEur">Capitale Iniziale (‚Ç¨):</label>
                    <input type="number" class="form-control" id="initialCapitalEur" placeholder="es. 10000" required
                        value="10000" min="0">
                </div>
                <div class="form-group col-md-3">
                    <label for="monthlyDepositEur">Versamento Mensile (‚Ç¨):</label>
                    <input type="number" class="form-control" id="monthlyDepositEur" placeholder="es. 200" required
                        value="200" min="0">
                </div>
                <div class="form-group col-md-3">
                    <label for="terFee">Costo Annuale (TER) [%]:</label>
                    <input type="number" class="form-control" id="terFee" placeholder="es. 0.1" step="0.1" required
                        value="0.1" min="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-3">
                    <label for="startDate">Data Inizio:</label>
                    <input type="date" class="form-control" id="startDate" required>
                </div>
                <div class="form-group col-md-3">
                    <label for="endDate">Data Fine:</label>
                    <input type="date" class="form-control" id="endDate" required>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Simula</button>
            <button id="resetZoomButton" class="btn btn-primary">Reset Zoom</button>
        </form>

        <!-- Grafico -->
        <h4 class="text-center">Grafico in denaro</h4>
        <canvas id="chartCanvas" height="100"></canvas>
        <h4 class="text-center">Grafico in %</h4>
        <canvas id="percentageChartCanvas" height="100"></canvas>
        <!-- Risultati della simulazione -->
        <div id="simulationResults" class="mt-4"></div>
    </div>

    <script>
        // Variabile globale per contenere il dataset
        let indexDatasetValues = [];

        // Variabile globale per contenere il dataset del cambio EUR/USD
        let exchangeRates = [];

        // Variabile per la Chart.js (per aggiornare il grafico se necessario)
        let chartInstance = null;
        let percentageChartInstance = null;

        let mindate = new Date("2000-01-01");
        let maxdate = new Date("2025-01-01");

        // Funzione per convertire una stringa data ("YYYY-MM-DD") in oggetto Date
        function parseDate(dateStr) {
            return new Date(dateStr);
        }

        // Carica il dataset dal file
        function loadDataset() {
            const selectedIndex = $('#indexSelect').val();
            const datasetFile = selectedIndex + '.json';

            return fetch(datasetFile)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Errore nel caricamento del dataset: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    // Assumiamo che data sia un array di oggetti con campi "Date" e "Close"
                    // Ordiniamo il dataset per data (crescente)
                    indexDatasetValues = data.sort((a, b) => new Date(a.Date) - new Date(b.Date));

                    // Impostiamo i limiti min e max dei campi data in base al dataset
                    if (indexDatasetValues.length > 0) {
                        minDate = indexDatasetValues[0].Date;
                        maxDate = indexDatasetValues[indexDatasetValues.length - 1].Date;
                        $('#startDate').attr('min', minDate);
                        $('#startDate').attr('max', maxDate);
                        $('#endDate').attr('min', minDate);
                        $('#endDate').attr('max', maxDate);
                    }

                    // Verifica se le date di inizio e fine sono valide
                    const startDateVal = $('#startDate').val();
                    const endDateVal = $('#endDate').val();
                    if (startDateVal && endDateVal) {
                        const startDate = parseDate(startDateVal);
                        const endDate = parseDate(endDateVal);
                        // Filtra il dataset per il range di date selezionato
                        indexDatasetValues = indexDatasetValues.filter(item => {
                            const itemDate = parseDate(item.Date);
                            return itemDate >= startDate && itemDate <= endDate;
                        });
                    }
                })
                .then(() => {
                    return loadExchangeRates();
                })
                .catch(error => {
                    console.error("Errore durante il caricamento del dataset:", error);
                });
        }

        // Carica il dataset del cambio EUR/USD dal file cambio_eur_usd.json
        function loadExchangeRates() {
            return fetch('cambio_eur_usd.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Errore nel caricamento del dataset del cambio: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    // Assumiamo che data sia un array di oggetti con campi "Date" e "Close"
                    // Ordiniamo il dataset per data (crescente)
                    var sortedData = data.sort((a, b) => new Date(a.Date) - new Date(b.Date));
                    exchangeRates = indexDatasetValues.map(item => {
                        const exchangeRate = sortedData.find(rate => rate.Date === item.Date);
                        return exchangeRate ? parseFloat(exchangeRate.Close) : null;
                    });

                    // Verifica se ci sono date senza tasso di cambio corrispondente
                    if (exchangeRates.includes(null)) {
                        throw new Error("Errore: alcune date nel dataset dell'indice non hanno un tasso di cambio corrispondente.");
                    }
                })
                .catch(error => {
                    console.error("Errore durante il caricamento del dataset del cambio:", error);
                });
        }

        // Carica il dataset all'avvio
        $(document).ready(function () {
            loadDataset().then(() => {
                // Impostiamo dei valori di default
                $('#startDate').val(minDate);
                $('#endDate').val(maxDate);
                runSimulation();
            }).catch(error => {
                console.error("Errore durante il caricamento del dataset:", error);
            });
        });

        // Funzione per calcolare la deviazione standard
        function calcolaDeviazioneStandard(arr) {
            const media = arr.reduce((acc, val) => acc + val, 0) / arr.length;
            const varianza = arr.reduce((acc, val) => acc + Math.pow(val - media, 2), 0) / arr.length;
            return Math.sqrt(varianza);
        }

        // Funzione per calcolare il drawdown massimo
        function calcolaMaxDrawdown(valori) {
            let maxDrawdown = 0;
            let maxValore = valori[0];
            for (let i = 1; i < valori.length; i++) {
                if (valori[i] > maxValore) {
                    maxValore = valori[i];
                }
                const drawdown = (maxValore - valori[i]) / maxValore;
                if (drawdown > maxDrawdown) {
                    maxDrawdown = drawdown;
                }
            }
            return maxDrawdown;
        }

        // Funzione per calcolare il drawdown massimo in valore assoluto
        function calcolaMaxDrawdownValore(valori) {
            let maxDrawdownValore = 0;
            let maxValore = valori[0];
            for (let i = 1; i < valori.length; i++) {
                if (valori[i] > maxValore) {
                    maxValore = valori[i];
                }
                const drawdownValore = maxValore - valori[i];
                if (drawdownValore > maxDrawdownValore) {
                    maxDrawdownValore = drawdownValore;
                }
            }
            return maxDrawdownValore;
        }

        // Funzione per creare il grafico percentuale
        function createPercentageChart(dates, netValuesEur, netValuesDollar) {
            const ctx = document.getElementById('percentageChartCanvas').getContext('2d');
            if (percentageChartInstance) {
                percentageChartInstance.destroy();
            }
            percentageChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Nettissimo (‚Ç¨)',
                            data: netValuesEur.map((value, index) => ((value / netValuesEur[0]) - 1) * 100),
                            borderColor: 'rgba(255, 99, 132, 0.6)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'Nettissimo ($)',
                            data: netValuesDollar.map((value, index) => ((value / netValuesDollar[0]) - 1) * 100),
                            borderColor: 'rgba(54, 162, 235, 0.6)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: false,
                                },
                                pinch: {
                                    enabled: false
                                },
                                mode: 'x',
                                drag: {
                                    enabled: true,
                                    backgroundColor: 'rgba(0,0,0,0.3)',
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                tooltipFormat: 'yyyy-MM-dd'
                            },
                            title: {
                                display: true,
                                text: 'Data'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Percentuale'
                            },
                            ticks: {
                                callback: function (value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }


        // Funzione per eseguire la simulazione
        function runSimulation() {
            // Legge i parametri di input
            const initialCapitalEur = parseFloat($('#initialCapitalEur').val());
            const monthlyDepositEur = parseFloat($('#monthlyDepositEur').val());
            const terFee = parseFloat($('#terFee').val()); // espresso in percentuale
            const startDate = new Date($('#startDate').val());
            const endDate = new Date($('#endDate').val());
            const initialCapitalDollar = initialCapitalEur * exchangeRates[0];

            // Filtra il dataset per il range di date selezionato
            const simData = indexDatasetValues.filter(item => {
                const itemDate = parseDate(item.Date);
                return itemDate >= startDate && itemDate <= endDate;
            });

            if (simData.length < 2) {
                alert("Non ci sono abbastanza dati nel range selezionato.");
                return;
            }

            // Array per memorizzare le date e i valori simulati
            const dates = [];
            const grossValuesDollar = [];
            const netValuesDollar = [];
            const nettissimoValuesDollar = [];
            const totalDepositsDollar = [];
            const grossValuesEur = [];
            const netValuesEur = [];
            const nettissimoValuesEur = [];
            const totalDepositsEur = [];

            // Per il calcolo delle plusvalenze, memorizziamo i contributi cumulativi
            let cumulativeContributionsDollar = initialCapitalEur * exchangeRates[0];
            let cumulativeContributionsEur = initialCapitalEur;

            // Per applicare il TER su base giornaliera (si assume 252 giorni di trading/anno)
            const terDaily = (terFee / 100) / 252;

            // Inizializziamo la simulazione con il primo giorno disponibile
            let currentGrossDollar = initialCapitalEur * exchangeRates[0];
            let currentNetDollar = initialCapitalEur * exchangeRates[0];
            let currentGrossEur = initialCapitalEur;
            let currentNetEur = initialCapitalEur;
            dates.push(simData[0].Date);
            grossValuesDollar.push(currentGrossDollar);
            netValuesDollar.push(currentNetDollar);
            totalDepositsDollar.push(currentGrossDollar);
            grossValuesEur.push(currentGrossEur);
            netValuesEur.push(currentNetEur);
            totalDepositsEur.push(currentGrossEur);
            let gainDollar = currentNetDollar - cumulativeContributionsDollar;
            let currentNettissimoDollar = currentNetDollar - (gainDollar > 0 ? gainDollar * 0.26 : 0);
            nettissimoValuesDollar.push(currentNettissimoDollar);
            let gainEur = currentNetEur - cumulativeContributionsEur;
            let currentNettissimoEur = currentNetEur - (gainEur > 0 ? gainEur * 0.26 : 0);
            nettissimoValuesEur.push(currentNettissimoEur);

            // Per gestire il deposito mensile, teniamo traccia del mese dell'ultimo deposito
            let lastDepositMonth = parseDate(simData[0].Date).getMonth();

            // Itera sui dati a partire dal secondo giorno
            for (let i = 1; i < simData.length; i++) {
                // Calcola il rendimento giornaliero usando i dati "Close"
                const prevPriceDollar = parseFloat(simData[i - 1]["Close"]);
                const currPriceDollar = parseFloat(simData[i]["Close"]);
                const dailyReturnDollar = (currPriceDollar / prevPriceDollar) - 1;

                // Aggiorna i valori lordo e netto in base al rendimento giornaliero
                currentGrossDollar = currentGrossDollar * (1 + dailyReturnDollar);
                currentNetDollar = currentNetDollar * (1 + dailyReturnDollar) * (1 - terDaily);
                currentGrossEur = currentGrossDollar / exchangeRates[i];
                currentNetEur = currentNetDollar / exchangeRates[i];

                // Se √® cambiato il mese (rispetto all'ultimo deposito) aggiungiamo il versamento mensile
                const currentDate = parseDate(simData[i].Date);
                const currentMonth = currentDate.getMonth();
                if (currentMonth !== lastDepositMonth) {
                    currentGrossDollar += monthlyDepositEur * exchangeRates[i];
                    currentNetDollar += monthlyDepositEur * exchangeRates[i];
                    cumulativeContributionsDollar += monthlyDepositEur * exchangeRates[i];
                    totalDepositsDollar.push(cumulativeContributionsDollar);
                    currentGrossEur += monthlyDepositEur;
                    currentNetEur += monthlyDepositEur;
                    cumulativeContributionsEur += monthlyDepositEur;
                    totalDepositsEur.push(cumulativeContributionsEur);
                    lastDepositMonth = currentMonth;
                } else {
                    totalDepositsDollar.push(cumulativeContributionsDollar);
                    totalDepositsEur.push(cumulativeContributionsEur);
                }

                // Calcola il valore "nettissimo": si tassano al 26% le plusvalenze (guadagno oltre i contributi)
                gainDollar = currentNetDollar - cumulativeContributionsDollar;
                currentNettissimoDollar = currentNetDollar - (gainDollar > 0 ? gainDollar * 0.26 : 0);
                gainEur = currentNetEur - cumulativeContributionsEur;
                currentNettissimoEur = currentNetEur - (gainEur > 0 ? gainEur * 0.26 : 0);

                // Salva i dati per il grafico
                dates.push(simData[i].Date);
                grossValuesDollar.push(currentGrossDollar);
                netValuesDollar.push(currentNetDollar);
                nettissimoValuesDollar.push(currentNettissimoDollar);
                grossValuesEur.push(currentGrossEur);
                netValuesEur.push(currentNetEur);
                nettissimoValuesEur.push(currentNettissimoEur);
            }

            // Calcola la volatilit√† (deviazione standard)
            const rendimentiGiornalieriNetDollar = simData.map((item, index) => {
                if (index === 0) return 0;
                const prevNet = netValuesDollar[index - 1];
                const currNet = netValuesDollar[index];
                return (currNet / prevNet) - 1;
            }).slice(1);

            // Calcola i rendimenti giornalieri in euro
            const rendimentiGiornalieriNetEur = simData.map((item, index) => {
                if (index === 0) return 0;
                const prevNetEur = netValuesEur[index - 1];
                const currNetEur = netValuesEur[index];
                return (currNetEur / prevNetEur) - 1;
            }).slice(1);

            const volatilitaNetEur = calcolaDeviazioneStandard(rendimentiGiornalieriNetEur);
            const volatilitaNetDollar = calcolaDeviazioneStandard(rendimentiGiornalieriNetDollar);

            // Calcola il drawdown massimo sul netto
            const maxDrawdownNetDollar = calcolaMaxDrawdown(netValuesDollar);
            const maxDrawdownNetEur = calcolaMaxDrawdown(netValuesEur);
            const maxDrawdownValoreNetEur = calcolaMaxDrawdownValore(netValuesEur);
            const maxDrawdownValoreNetDollar = calcolaMaxDrawdownValore(netValuesDollar);
            createPercentageChart(dates, nettissimoValuesEur, nettissimoValuesDollar);
            // Crea (o aggiorna) il grafico con Chart.js
            const ctx = document.getElementById('chartCanvas').getContext('2d');
            if (chartInstance) {
                chartInstance.destroy();
            }
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Lordo ($)',
                            data: grossValuesDollar,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            hidden: true
                        },
                        {
                            label: 'Netto ($)',
                            data: netValuesDollar,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            hidden: true
                        },
                        {
                            label: 'Nettissimo ($)',
                            data: nettissimoValuesDollar,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'Totale Versato ($)',
                            data: totalDepositsDollar,
                            borderColor: 'rgba(255, 206, 86, 1)',
                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                            fill: false,
                            tension: 1,
                            stepped: 'before',
                            pointRadius: 0,
                            hidden: true
                        },
                        {
                            label: 'Lordo (‚Ç¨)',
                            data: grossValuesEur,
                            borderColor: 'rgba(75, 192, 192, 0.6)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            hidden: true
                        },
                        {
                            label: 'Netto (‚Ç¨)',
                            data: netValuesEur,
                            borderColor: 'rgba(255, 99, 132, 0.6)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            hidden: true
                        },
                        {
                            label: 'Nettissimo (‚Ç¨)',
                            data: nettissimoValuesEur,
                            borderColor: 'rgba(54, 162, 235, 0.6)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'Totale Versato (‚Ç¨)',
                            data: totalDepositsEur,
                            borderColor: 'rgba(255, 206, 86, 0.6)',
                            backgroundColor: 'rgba(255, 206, 86, 0.1)',
                            fill: false,
                            tension: 1,
                            stepped: 'before',
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: false,
                                },
                                pinch: {
                                    enabled: false
                                },
                                mode: 'x',
                                drag: {
                                    enabled: true,
                                    backgroundColor: 'rgba(0,0,0,0.3)',
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                tooltipFormat: 'yyyy-MM-dd'
                            },
                            title: {
                                display: true,
                                text: 'Data'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Valore'
                            }
                        }
                    }
                }
            });


            // Funzione per formattare i numeri in euro con separatore delle migliaia
            function formatEuro(value) {
                return new Intl.NumberFormat('it-IT',
                    {
                        style: 'currency',
                        currency: 'EUR',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(value);
            }

            // Funzione per formattare i numeri in euro con separatore delle migliaia
            function formatDollar(value) {
                return new Intl.NumberFormat('en-US',
                    {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(value);
            }

            // Funzione per calcolare il rendimento totale e annualizzato (CAGR)
            function calcolaRendimento(valoreFinale, valoreIniziale, anniTotali, totaleVersamenti) {
                const rendimentoTotale = ((valoreFinale - totaleVersamenti) / totaleVersamenti) * 100;
                const rendimentoAnnualizzato = (((valoreFinale / totaleVersamenti) ** (1 / anniTotali)) - 1) * 100;

                return {
                    rendimentoTotale: rendimentoTotale,
                    rendimentoAnnualizzato: rendimentoAnnualizzato
                };
            }

            // Funzione per formattare le percentuali
            function formatPercent(value) {
                return value.toFixed(1) + '%';
            }

            // Visualizza i risultati finali della simulazione
            const finalIndex = dates.length - 1;
            const finalGrossDollar = grossValuesDollar[finalIndex];
            const finalNetDollar = netValuesDollar[finalIndex];
            const finalNettissimoDollar = nettissimoValuesDollar[finalIndex];
            const finalGrossEur = grossValuesEur[finalIndex];
            const finalNetEur = netValuesEur[finalIndex];
            const finalNettissimoEur = nettissimoValuesEur[finalIndex];

            // Calcolo delle differenze
            const diffGrossNetDollar = finalGrossDollar - finalNetDollar;
            const diffGrossNetPercDollar = (diffGrossNetDollar / finalGrossDollar) * 100;

            const diffGrossNettissimoDollar = finalGrossDollar - finalNettissimoDollar;
            const diffGrossNettissimoPercDollar = (diffGrossNettissimoDollar / finalGrossDollar) * 100;

            const anniTotali = (new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24 * 365.25);

            const rendimentoLordoDollar = calcolaRendimento(finalGrossDollar, initialCapitalDollar, anniTotali, cumulativeContributionsDollar);
            const rendimentoNettoDollar = calcolaRendimento(finalNetDollar, initialCapitalDollar, anniTotali, cumulativeContributionsDollar);
            const rendimentoNettissimoDollar = calcolaRendimento(finalNettissimoDollar, initialCapitalDollar, anniTotali, cumulativeContributionsDollar);
            const rendimentoLordoEur = calcolaRendimento(finalGrossEur, initialCapitalEur, anniTotali, cumulativeContributionsEur);
            const rendimentoNettoEur = calcolaRendimento(finalNetEur, initialCapitalEur, anniTotali, cumulativeContributionsEur);
            const rendimentoNettissimoEur = calcolaRendimento(finalNettissimoEur, initialCapitalEur, anniTotali, cumulativeContributionsEur);

            let resultHtml = `<h3>Risultati della simulazione</h3>`;
            resultHtml += `<div class="box">`;
            resultHtml += `<p><strong>Capitale Investito:</strong> ${formatEuro(cumulativeContributionsEur)}</p>`;
            resultHtml += `<p><strong>Durata Simulazione:</strong> ${anniTotali.toFixed(1)} anni</p>`;
            resultHtml += `</div>`;

            resultHtml += `<div class="accordion" id="accordionResults">`;

            // Rendimento in Euro
            resultHtml += `<div class="card">`;
            resultHtml += `<div class="card-header bg-primary text-white" id="headingEuro">`;
            resultHtml += `<h2 class="mb-0">`;
            resultHtml += `<button class="btn btn-link text-white" type="button" data-toggle="collapse" data-target="#collapseEuro" aria-expanded="true" aria-controls="collapseEuro">`;
            resultHtml += `Rendimenti in Euro (‚Ç¨) <span class="fas fa-chevron-down"></span>`;
            resultHtml += `</button>`;
            resultHtml += `</h2>`;
            resultHtml += `</div>`;

            resultHtml += `<div id="collapseEuro" class="collapse show" aria-labelledby="headingEuro" data-parent="#accordionResults">`;
            resultHtml += `<div class="card-body">`;

            resultHtml += `<div class="box">`;
            resultHtml += `<p><strong>Rendimento assoluto Lordo (‚Ç¨):</strong> ${formatEuro(finalGrossEur)}</p>`;
            resultHtml += `<p><strong>Rendimento Totale Lordo (‚Ç¨):</strong> ${formatPercent(rendimentoLordoEur.rendimentoTotale)}</p>`;
            resultHtml += `<p><strong>Rendimento Annualizzato Lordo (CAGR) (‚Ç¨):</strong> ${formatPercent(rendimentoLordoEur.rendimentoAnnualizzato)}</p>`;
            resultHtml += `</div>`;

            resultHtml += `<div class="box">`;
            resultHtml += `<p><strong>Rendimento assoluto Netto (‚Ç¨):</strong> ${formatEuro(finalNetEur)}</p>`;
            resultHtml += `<p><strong>Rendimento Totale Netto (‚Ç¨):</strong> ${formatPercent(rendimentoNettoEur.rendimentoTotale)}</p>`;
            resultHtml += `<p><strong>Rendimento Annualizzato Netto (CAGR) (‚Ç¨):</strong> ${formatPercent(rendimentoNettoEur.rendimentoAnnualizzato)}</p>`;
            resultHtml += `</div>`;

            resultHtml += `<div class="box">`;
            resultHtml += `<p><strong>Rendimento Nettissimo (‚Ç¨):</strong> ${formatEuro(finalNettissimoEur)}</p>`;
            resultHtml += `<p><strong>Rendimento Totale Nettissimo (‚Ç¨):</strong> ${formatPercent(rendimentoNettissimoEur.rendimentoTotale)}</p>`;
            resultHtml += `<p><strong>Rendimento Annualizzato Nettissimo (CAGR) (‚Ç¨):</strong> ${formatPercent(rendimentoNettissimoEur.rendimentoAnnualizzato)}</p>`;
            resultHtml += `</div>`;

            resultHtml += `<div class="box">`;
            resultHtml += `<p><strong>Diff. Lordo - Netto  (TWR Terminal Wealth Ratio):</strong> ${formatEuro(diffGrossNetDollar)} (${formatPercent(diffGrossNetPercDollar)})</p>`;
            resultHtml += `<p><strong>Diff. Lordo - Nettissimo (tassazione effetiva sul totale lordo):</strong> ${formatEuro(diffGrossNettissimoDollar)} (${formatPercent(diffGrossNettissimoPercDollar)})</p>`;
            resultHtml += `<p>Nota, questa percentuale pu√≤ risultare < 26% perch√® mostrando la differenza con il lordo, comprende anche il TER, che in quanto spesa, non partecipa al capital gain e non viene tassata.
                Inoltre, solo il gain viene tassato al 26% e non l'intera somma lorda.</p>`;
            resultHtml += `</div>`;

            resultHtml += `<div class="box">`;
            resultHtml += `<p><strong>Volatilit√† (Deviazione Standard) ‚Ç¨ (sul netto):</strong> ${formatPercent(volatilitaNetEur * 100)}</p>`;
            resultHtml += `<p><strong>Drawdown Massimo (MDD) ‚Ç¨ (sul netto):</strong> perdita del ${formatPercent(maxDrawdownNetEur * 100)}</p>`;
            resultHtml += `<p><strong>Drawdown Massimo (MDD) (‚Ç¨) (sul netto):</strong> perdita di ${formatEuro(maxDrawdownValoreNetEur)} (su capitale che al momento era di ${formatEuro(maxDrawdownValoreNetEur / maxDrawdownNetEur)})</p>`;
            resultHtml += `</div>`;

            resultHtml += `</div>`;
            resultHtml += `</div>`;
            resultHtml += `</div>`;

            // Rendimento in Dollari
            resultHtml += `<div class="card">`;
            resultHtml += `<div class="card-header bg-secondary text-white" id="headingDollar">`;
            resultHtml += `<h2 class="mb-0">`;
            resultHtml += `<button class="btn btn-link text-white collapsed" type="button" data-toggle="collapse" data-target="#collapseDollar" aria-expanded="false" aria-controls="collapseDollar">`;
            resultHtml += `Rendimenti in Dollari ($) <span class="fas fa-chevron-down"></span>`;
            resultHtml += `</button>`;
            resultHtml += `</h2>`;
            resultHtml += `</div>`;
            resultHtml += `</button>`;
            resultHtml += `</h2>`;
            resultHtml += `</div>`;

            resultHtml += `<div id="collapseDollar" class="collapse" aria-labelledby="headingDollar" data-parent="#accordionResults">`;
            resultHtml += `<div class="card-body">`;

            resultHtml += `<div class="box">`;
            resultHtml += `<p><strong>Rendimento assoluto Lordo ($):</strong> ${formatDollar(finalGrossDollar)}</p>`;
            resultHtml += `<p><strong>Rendimento Totale Lordo ($):</strong> ${formatPercent(rendimentoLordoDollar.rendimentoTotale)}</p>`;
            resultHtml += `<p><strong>Rendimento Annualizzato Lordo (CAGR) ($):</strong> ${formatPercent(rendimentoLordoDollar.rendimentoAnnualizzato)}</p>`;
            resultHtml += `</div>`;

            resultHtml += `<div class="box">`;
            resultHtml += `<p><strong>Rendimento assoluto Netto ($):</strong> ${formatDollar(finalNetDollar)}</p>`;
            resultHtml += `<p><strong>Rendimento Totale Netto ($):</strong> ${formatPercent(rendimentoNettoDollar.rendimentoTotale)}</p>`;
            resultHtml += `<p><strong>Rendimento Annualizzato Netto (CAGR) ($):</strong> ${formatPercent(rendimentoNettoDollar.rendimentoAnnualizzato)}</p>`;
            resultHtml += `</div>`;

            resultHtml += `<div class="box">`;
            resultHtml += `<p><strong>Rendimento Nettissimo ($):</strong> ${formatDollar(finalNettissimoDollar)}</p>`;
            resultHtml += `<p><strong>Rendimento Totale Nettissimo ($):</strong> ${formatPercent(rendimentoNettissimoDollar.rendimentoTotale)}</p>`;
            resultHtml += `<p><strong>Rendimento Annualizzato Nettissimo (CAGR) ($):</strong> ${formatPercent(rendimentoNettissimoDollar.rendimentoAnnualizzato)}</p>`;
            resultHtml += `</div>`;

            resultHtml += `<div class="box">`;
            resultHtml += `<p><strong>Volatilit√† (Deviazione Standard) $ (sul netto):</strong> ${formatPercent(volatilitaNetDollar * 100)}</p>`;
            resultHtml += `<p><strong>Drawdown Massimo (MDD) $ (sul netto):</strong> perdita del ${formatPercent(maxDrawdownNetDollar * 100)}</p>`;
            resultHtml += `<p><strong>Drawdown Massimo (MDD) ($) (sul netto):</strong> perdita di ${formatDollar(maxDrawdownValoreNetDollar)} (su capitale che al momento era di ${formatEuro(maxDrawdownValoreNetDollar / maxDrawdownNetDollar)})</p>`;
            resultHtml += `</div>`;


            resultHtml += `</div>`;
            resultHtml += `</div>`;
            resultHtml += `</div>`;
            resultHtml += `</div>`;

            $('#simulationResults').html(resultHtml);
        }

        // Gestione del submit del form
        $('#simulationForm').on('submit', function (e) {
            e.preventDefault();
            loadDataset().then(() => {
                runSimulation();
            });
        });

        // Aggiungi questo evento per aggiornare le date min e max quando cambia l'indice selezionato
        $('#indexSelect').on('change', function () {
            loadDataset().then(() => {
                minDate = indexDatasetValues[0].Date;
                maxDate = indexDatasetValues[indexDatasetValues.length - 1].Date;
                // Imposta i valori di default per le date di inizio e fine
                $('#startDate').val(minDate);
                $('#endDate').val(maxDate);
            }).catch(error => {
                console.error("Errore durante il caricamento del dataset:", error);
            });
        });

        // Aggiungi evento per il pulsante di reset dello zoom
        $('#resetZoomButton').click(function () {
            if (chartInstance) {
                chartInstance.resetZoom();
            }
        });

        // Aggiungi questo script per gestire la freccia apri/chiudi
        $(document).ready(function () {
            $('.collapse').on('show.bs.collapse', function () {
                $(this).prev('.card-header').find('.fas').removeClass('fa-chevron-down').addClass('fa-chevron-up');
            }).on('hide.bs.collapse', function () {
                $(this).prev('.card-header').find('.fas').removeClass('fa-chevron-up').addClass('fa-chevron-down');
            });
        });
    </script>

    <!-- Bootstrap JS (con Popper) -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <!-- Disclaimer -->
    <div class="disclaimer">
        <p><strong>Disclaimer:</strong> Le informazioni e i calcoli forniti in questa pagina sono a scopo puramente
            informativo e non costituiscono in alcun modo una consulenza finanziaria, fiscale, legale o professionale.
            Sebbene sia stata posta la massima cura nella preparazione di questi calcoli, non si garantisce
            l‚Äôaccuratezza, la completezza o l'affidabilit√† delle informazioni fornite. L'utente si assume la piena
            responsabilit√† per l'uso delle informazioni presenti e per eventuali decisioni o azioni intraprese in base
            ai risultati di tali calcoli.</p>
        <p>L‚Äôautore declina espressamente ogni responsabilit√† per eventuali perdite, danni o spese derivanti dall'uso o
            dall'affidamento sui calcoli e le informazioni qui presenti. Si consiglia vivamente di consultare un
            professionista qualificato per valutazioni personalizzate e verificare tutte le informazioni con esperti
            prima di prendere qualsiasi decisione di investimento o finanziaria.</p>
    </div>
</body>

</html>